<%
  # Determine if this is a new record
  is_new_record = transaction.new_record?
  # Generate form ID
  form_id = is_new_record ? "new_transaction_inline_form" : dom_id(transaction, :inline_form)
%>

<td>
    <%= datetime_field_tag "transaction[transacted_at]",
          (transaction.transacted_at || (is_new_record ? Time.current : nil))&.strftime("%Y-%m-%dT%H:%M"),
          id: "#{form_id}_transacted_at",
          form: form_id %>
  </td>
  <td><span data-transaction-type-target="indicator"><%= is_new_record ? "" : transaction_type_indicator(transaction) %></span></td>
  <td>
    <%= text_field_tag "transaction[description]",
          transaction.description,
          id: "#{form_id}_description",
          form: form_id,
          placeholder: (is_new_record ? "Description" : nil) %>
  </td>
  <td>
    <%= select_tag "transaction[src_account_id]",
          account_options_with_kind(src_accounts, transaction.src_account_id, prompt: (is_new_record ? "From…" : nil)),
          id: "#{form_id}_src_account_id",
          form: form_id,
          data: { transaction_type_target: "src", action: "change->transaction-type#update" } %>
  </td>
  <td>
    <%= select_tag "transaction[dest_account_id]",
          account_options_with_kind(dest_accounts, transaction.dest_account_id, prompt: (is_new_record ? "To…" : nil)),
          id: "#{form_id}_dest_account_id",
          form: form_id,
          data: { transaction_type_target: "dest", action: "change->transaction-type#update" } %>
  </td>
  <td>
    <%= text_field_tag "transaction[amount]",
          transaction.amount,
          id: "#{form_id}_amount",
          form: form_id,
          placeholder: (is_new_record ? "0.00" : nil) %>
  </td>
  <td><span data-transaction-type-target="currency"><%= is_new_record ? "" : transaction.currency.code %></span></td>
  <td data-controller="category-picker">
    <%= select_tag "_category_select",
          options_for_select(
            [["— None —", ""]] +
            categories.map { |c| [c.name, c.id] } +
            [["+ New category…", "__new__"]],
            transaction.category_id
          ),
          id: "#{form_id}_category_select",
          form: form_id,
          data: { category_picker_target: "select", action: "change->category-picker#changed" } %>
    <div class="category-new-input" style="display:none" data-category-picker-target="newWrapper">
      <%= text_field_tag "_category_new", "",
            id: "#{form_id}_category_new",
            form: form_id,
            placeholder: "New category",
            data: { category_picker_target: "textInput", action: "input->category-picker#typed" } %>
      <a href="#" class="category-new-cancel" data-action="click->category-picker#back" title="Back to list">&times;</a>
    </div>
    <%= hidden_field_tag "transaction[category_id]", transaction.category_id, id: "#{form_id}_category_id", form: form_id, data: { category_picker_target: "idField" } %>
    <%= hidden_field_tag "transaction[category_name]", "", id: "#{form_id}_category_name", form: form_id, data: { category_picker_target: "nameField" } %>
  </td>
  <td><%= hidden_field_tag "transaction[cleared]", "0", id: "#{form_id}_cleared_hidden", form: form_id %><%= check_box_tag "transaction[cleared]", "1", transaction.cleared, id: "#{form_id}_cleared", form: form_id %></td>
  <td><%= is_new_record ? "" : (transaction.split ? "Split" : "") %></td>
  <td>
    <% if transaction.errors.any? %>
      <div style="color: red; font-size: 0.85em;">
        <% transaction.errors.full_messages.each do |msg| %>
          <div><%= msg %></div>
        <% end %>
      </div>
    <% end %>
    <%= form_with(model: is_new_record ? transaction : transaction,
                  url: is_new_record ? transactions_path : nil,
                  id: form_id) do |f| %>
      <%= f.submit is_new_record ? "Add" : "Save" %>
      <% unless is_new_record %>
        <a href="#" data-action="click->inline-edit#cancel">Cancel</a>
      <% end %>
    <% end %>
  </td>
